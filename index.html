<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Python Runner ‚Äî Upload ¬∑ Run ¬∑ Logs</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --bg:#071028; --card:#0f1724; --accent:#6C8CFF; --muted:#9fb0d6;
      --success:#4dd38a; --danger:#ff5c6c;
    }
    *{box-sizing:border-box}
    body{margin:0;background:linear-gradient(180deg,var(--bg),#020312);font-family:Inter,Arial;color:#e7f0ff}
    .wrap{max-width:1100px;margin:24px auto;padding:18px}
    header{display:flex;align-items:center;justify-content:space-between;gap:12px}
    h1{margin:0;font-size:20px}
    .muted{color:var(--muted);font-size:13px}
    .grid{display:grid;grid-template-columns:360px 1fr;gap:18px;margin-top:18px}
    .card{background:var(--card);padding:16px;border-radius:12px;box-shadow:0 8px 30px rgba(0,0,0,0.6)}
    button{background:var(--accent);border:none;color:white;padding:10px 12px;border-radius:8px;cursor:pointer;font-weight:600}
    button.warn{background:var(--danger)}
    .list{margin-top:12px;display:flex;flex-direction:column;gap:10px}
    .file{display:flex;justify-content:space-between;align-items:center;padding:10px;background:rgba(255,255,255,0.02);border-radius:8px}
    .file .meta{display:flex;flex-direction:column}
    .controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    pre{background:#02030a;padding:12px;border-radius:8px;color:#bfe9c9;white-space:pre-wrap;max-height:420px;overflow:auto}
    .small{font-size:13px;color:var(--muted)}
    .badge{padding:6px 8px;border-radius:8px;font-weight:700}
    .running{background:#0e2c23;color:var(--success)}
    .stopped{background:#2b0f13;color:var(--danger)}
    footer{margin-top:20px;color:var(--muted);font-size:13px;text-align:center}
    @media (max-width:880px){
      .grid{grid-template-columns:1fr; }
    }
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>üî• Python Runner ‚Äî Upload ¬∑ Run ¬∑ Logs</h1>
        <div class="small muted">Run Telegram bots or any long-running Python script on Render</div>
      </div>
      <div class="small muted" id="serviceUptime">Uptime: --</div>
    </header>

    <div class="grid">
      <!-- left column: upload & controls -->
      <div class="card">
        <h3>Upload script</h3>
        <form id="uploadForm">
          <input type="file" id="fileInput" accept=".py" required />
          <div style="height:10px"></div>
          <div class="controls">
            <button type="submit">Upload</button>
            <button id="refreshFiles" type="button" style="background:#233055">Refresh</button>
          </div>
        </form>

        <div style="height:14px"></div>
        <h4>Current script</h4>
        <div class="small muted">File: <span id="currentFile">‚Äî</span></div>
        <div class="small muted">Script runtime: <span id="scriptRuntime">‚Äî</span></div>

        <div style="height:8px"></div>
        <div class="controls" style="margin-top:10px">
          <button id="startBtn">Start</button>
          <button id="stopBtn" class="warn">Stop</button>
        </div>

        <div style="height:10px"></div>
        <h4 style="margin-top:12px">Files</h4>
        <div id="fileList" class="list"></div>
      </div>

      <!-- right column: logs -->
      <div class="card">
        <div style="display:flex;justify-content:space-between;align-items:center">
          <h3 style="margin:0">Live logs</h3>
          <div>
            <button id="clearLogs">Clear</button>
            <button id="downloadLog">Download Log</button>
          </div>
        </div>

        <div style="height:10px"></div>
        <pre id="logs">Loading logs...</pre>
      </div>
    </div>

    <footer>‚ö†Ô∏è Use trusted scripts only. Use environment variables in Render for secrets (BOT tokens).</footer>
  </div>

<script>
async function api(path, opts){ 
  const res = await fetch(path, opts || {});
  const ct = res.headers.get('content-type')||'';
  if(ct.includes('application/json')) return await res.json();
  return res;
}

async function refreshFiles(){
  const j = await api('/api/files');
  const files = j.files || [];
  const list = document.getElementById('fileList');
  list.innerHTML = '';
  let current = null;
  files.forEach(f=>{
    const item = document.createElement('div'); item.className='file';
    const meta = document.createElement('div'); meta.className='meta';
    meta.innerHTML = `<strong>${f}</strong><div class="small muted">${f}</div>`;
    const actions = document.createElement('div');
    // download
    const dl = document.createElement('a'); dl.href=`/api/download/${encodeURIComponent(f)}`; dl.textContent='Download'; dl.className='small'; dl.target='_blank'; dl.style.marginRight='8px';
    actions.appendChild(dl);
    // start button (for .py)
    if(f.toLowerCase().endsWith('.py')){
      const run = document.createElement('button'); run.textContent='Start'; run.onclick = ()=> startScript(f);
      const stop = document.createElement('button'); stop.textContent='Stop'; stop.onclick = ()=> stopScript();
      actions.appendChild(run); actions.appendChild(stop);
    }
    // delete
    const del = document.createElement('button'); del.textContent='Delete'; del.onclick = ()=> deleteFile(f);
    del.style.marginLeft = '8px';
    actions.appendChild(del);

    item.appendChild(meta); item.appendChild(actions);
    list.appendChild(item);
    if(!current) current = f;
  });
  // show current uploaded file (the UI treats the last uploaded file as "current")
  document.getElementById('currentFile').innerText = files.length ? files[files.length-1] : '‚Äî';
}

document.getElementById('refreshFiles').addEventListener('click', refreshFiles);

document.getElementById('uploadForm').addEventListener('submit', async (e)=>{
  e.preventDefault();
  const file = document.getElementById('fileInput').files[0];
  if(!file) return alert('Choose a file');
  const fd = new FormData(); fd.append('file', file);
  const r = await fetch('/api/upload', {method:'POST', body: fd});
  const j = await r.json();
  if(j.ok){ alert('Uploaded: '+j.filename); await refreshFiles(); }
  else alert('Upload error: '+(j.error||'unknown'));
});

// Start script (runs the last uploaded or provided filename)
async function startScript(filename=null){
  if(!filename){
    const f = document.getElementById('currentFile').innerText;
    if(!f || f==='‚Äî') return alert('No file to start');
    filename = f;
  }
  const r = await fetch('/api/start', {method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({filename})});
  const j = await r.json();
  if(j.ok) {
    alert('Started pid: '+ j.pid);
  } else {
    alert('Start error: '+ (j.error || JSON.stringify(j)));
  }
  await updateStatus();
}

// Stop current running script
async function stopScript(){
  const r = await fetch('/api/stop', {method:'POST'});
  const j = await r.json();
  if(j.ok) alert('Stopped');
  else alert('Stop error: '+ (j.error || JSON.stringify(j)));
  await updateStatus();
}

async function deleteFile(name){
  if(!confirm('Delete '+name+' ?')) return;
  const r = await fetch('/api/delete/'+encodeURIComponent(name), {method:'POST'});
  const j = await r.json();
  if(j.ok){ alert('Deleted'); await refreshFiles(); }
  else alert('Delete error: '+(j.error||JSON.stringify(j)));
}

// logs polling
async function loadLogs(){
  const res = await fetch('/api/logs');
  const text = await res.text();
  document.getElementById('logs').textContent = text;
}
setInterval(loadLogs, 1800);
setInterval(updateStatus, 3500);

// status & runtime
async function updateStatus(){
  const s = await fetch('/api/status');
  const j = await s.json();
  document.getElementById('serviceUptime').innerText = 'Uptime: ' + (j.service_uptime.display || '--');
  if(j.script_running){
    document.getElementById('scriptRuntime').innerText = j.script_runtime.display;
  } else {
    document.getElementById('scriptRuntime').innerText = '‚Äî';
  }
}

// clear logs (client-side only)
document.getElementById('clearLogs').addEventListener('click', ()=>{ document.getElementById('logs').textContent = ''; });

// download log for current running file
document.getElementById('downloadLog').addEventListener('click', async ()=>{
  const s = await fetch('/api/status');
  const j = await s.json();
  const fname = j.script_meta && j.script_meta.filename;
  if(!fname) return alert('No running script log available');
  const url = `/api/download/${encodeURIComponent(fname)}.log`;
  window.open(url, '_blank');
});

// initial
refreshFiles();
loadLogs();
updateStatus();
</script>
</body>
</html>
